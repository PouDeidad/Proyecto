<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Distancia con Mapa</title>
  <!-- Incluir Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="default.css">
  <style>
    #map { height: 400px; width: 50%; }
  </style>
</head>
<body>
  <header>
        <h1><a href="index.html" class="iman">VIAJES EL TAQUILLOS</a></h1>
        <form>
            <label for="bus">Busqueda: </label> <input type="text" id="bus" autocomplete="off">
            <button>+</button>
        </form>
    </header><br><center>
  <h1>Selecciona dos puntos en el mapa</h1><br><br>
  <div id="map"></div><br>
  <h1>Distancia entre los puntos: <span id="resultado"></span> metros</h1><br><br>
  <button onclick="reiniciarMapa()">Reiniciar</button>
  <button onclick="enviarDatos()">Enviar</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Crear el mapa y configurarlo para iniciar en Aguascalientes
    var map = L.map('map').setView([21.8853, -102.2916], 13); //Coordenadas de Aguascalientes

    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var puntoA = null;
    var puntoB = null;
    var marcadorA = null;
    var marcadorB = null;

    // Función para calcular la distancia usando OpenRouteService
    function calcularDistancia(latA, lonA, latB, lonB) {
      let request = new XMLHttpRequest();

      request.open('POST', "https://api.openrouteservice.org/v2/directions/driving-car");
      request.setRequestHeader('Accept', 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8');
      request.setRequestHeader('Content-Type', 'application/json');
      request.setRequestHeader('Authorization', '5b3ce3597851110001cf6248ace72e03cf224932867ad8bdf8f02628');

      request.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
          const response = JSON.parse(this.responseText);
          const distancia = response.routes[0].segments[0].distance; // En metros
          document.getElementById('resultado').textContent = distancia;
        }
      };

      const body = JSON.stringify({
        "coordinates": [
          [lonA, latA],
          [lonB, latB]
        ]
      });

      request.send(body);
    }

    // Función para manejar el evento de clic en el mapa
    map.on('click', function(e) {
      if (!puntoA) {
        // Seleccionar el punto A
        puntoA = e.latlng;
        marcadorA = L.marker(puntoA).addTo(map).bindPopup('Punto A').openPopup();
      } else if (!puntoB) {
        // Seleccionar el punto B
        puntoB = e.latlng;
        marcadorB = L.marker(puntoB).addTo(map).bindPopup('Punto B').openPopup();

        // Calcular la distancia una vez que ambos puntos se seleccionen
        calcularDistancia(puntoA.lat, puntoA.lng, puntoB.lat, puntoB.lng);
      }
    });

    // Función para reiniciar el mapa y los puntos seleccionados
    function reiniciarMapa() {
      // Eliminar los marcadores y reiniciar las variables
      if (marcadorA) {
        map.removeLayer(marcadorA);
      }
      if (marcadorB) {
        map.removeLayer(marcadorB);
      }
      
      puntoA = null;
      puntoB = null;
      document.getElementById('resultado').textContent = ''; // Limpiar el resultado

      // Resetear la vista del mapa a Aguascalientes
      map.setView([21.8853, -102.2916], 13); // Coordenadas de Aguascalientes
    }
    // Función para enviar los datos a PHP
    function enviarDatos() {
     var distancia = document.getElementById('resultado').textContent;

     if (distancia) {
       // Crear un formulario dinámicamente
       var form = document.createElement('form');
       form.method = 'post';
       form.action = 'enviar.php'; // Reemplaza con la URL de tu archivo PHP

       // Crear campo oculto para la distancia
       var distanciaInput = document.createElement('input');
       distanciaInput.type = 'hidden';
       distanciaInput.name = 'distancia';
       distanciaInput.value = distancia;
       form.appendChild(distanciaInput);

       // Agregar el formulario al documento y enviarlo
       document.body.appendChild(form);
       form.submit();
     } else {
       alert('Por favor, calcula la distancia primero seleccionando los puntos en el mapa.');
     }
     }
  </script>

</body>
</html>
